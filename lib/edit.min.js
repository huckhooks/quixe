Hotkeys={bound:false,queue:[],hotkeys:[],match:false,keycodes:{backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,caps:20,esc:27,pgup:33,pgdown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46,"0":48,"1":49,"2":50,"3":51,"4":52,"5":53,"6":54,"7":55,"8":56,"9":57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,"left-win":91,"right-win":92,select:93,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,multiply:106,add:107,subtract:109,dec:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,num:144,scroll:145,"semi-colon":186,equal:187,comma:188,dash:189,period:190,slash:191,grave:192,"open-bracket":219,backslash:220,"close-braket":221,"single-quote":222},bind:function(d,c){var b=Array.prototype.slice.call(arguments);b.shift();b.shift();var a=new Hotkey(d,c,b);this.hotkeys.push(a)},keydown:function(d){var b=d.element();if(b.tagName=="INPUT"||b.tagName=="TEXTAREA"){return}var c=d.keyCode?d.keyCode:d.charCode;if(Hotkeys.queue.indexOf(c)==-1){Hotkeys.queue.push(c);Hotkeys.queue.sort();var a=Hotkeys.hotkeys.find(function(e){return e.keycodes.toString()==Hotkeys.queue.toString()});if(a){Hotkeys.match=true;d.cancelBubble=true;d.returnValue=false;if(d.stopPropagation){d.stopPropagation();d.preventDefault()}d.stop();a.trigger();Hotkeys.release()}}},keyup:function(b){var a=b.keyCode?b.keyCode:b.charCode;Hotkeys.queue.splice(Hotkeys.queue.indexOf(a),1)},keypress:function(a){if(Hotkeys.match){a.stop()}},release:function(){Hotkeys.queue=[];Hotkeys.match=false}};Hotkey=Class.create(Abstract,{initialize:function(b,a,c){if(!Hotkeys.bound){Hotkeys.bound=true;Event.observe(document,"keydown",Hotkeys.keydown);Event.observe(document,"keyup",Hotkeys.keyup);Event.observe(document,"keypress",Hotkeys.keypress)}this.combo=b.split("+");this.action=a;this.params=c;this.keycodes=[];if(this.combo){this.combo.each((function(d){this.keycodes.push(Hotkeys.keycodes[d])}).bind(this));this.keycodes.sort()}},trigger:function(){if(typeof(this.action)=="function"){this.action.apply(this,this.params)}}});HackHooksFrame={last_hash:null,initInParent:function(){if(false){var a=this;window.addEventListener("message",function(c){console.log(JSON.stringify([c.data,c.origin]));var b=JSON.parse(c.data);a.receiveMessage(b,c)},false)}},receiveMessage:function(b,a){console.log("receiveMessage>"+JSON.stringify(b));console.log("handle_"+b[0]);this["handle_"+b[0]](b[1],a)},handle_started:function(){},handle_subframe_sets_hash:function(a){console.log("handle_subframe_sets_hash>"+a);location.hash=a;last_hash=a},handle_edit:function(a){Edit.find(a)}};HackHooksFrame.initInParent();Edit.SKIP_GAME=false;Edit.dump=function(){console.log("dump");return false};Edit.find=function(b){var h=10;var c=$("editdiv").firstChild;var d=false;b=b.replace("Ä","Ae","g");b=b.replace("Ö","Oe","g");b=b.replace("Ü","Ue","g");b=b.replace("ä","ae","g");b=b.replace("ö","oe","g");b=b.replace("ü","ue","g");b=b.replace("ß","ss","g");var g=new RegExp(b+" (is|are) ","i");while(c){if(c.nodeName==="#text"){if(g.exec(c.textContent)){console.log(c.textContent);d=true;break}}c=c.nextSibling}if(d){c=c.previousSibling;console.log(c);var a=$("linemark");if(a){a.remove()}hash=Base64.decode(location.hash.substring(1));try{hash=JSON.parse(hash)}catch(f){console.log(f);hash={}}console.log(hash);if(hash.ct){hash.ct++}else{hash.ct=1}console.log(hash);HackHooksFrame.last_hash=Base64.encode(JSON.stringify(hash));c.insert({after:'<a name="'+HackHooksFrame.last_hash+'" id="linemark"><hr></a>'});location.hash=HackHooksFrame.last_hash}};Edit.next_mode=function(){var b=$("mode").textContent;console.log(b);if(b=="mix>play"){$("mode").update("play>edit");$("editdiv").hide();$("quixeframe").className="quixeframe_play"}else{if(b=="play>edit"){$("mode").update("edit>map");$("quixeframe").hide();$("editdiv").className="editdiv_edit";$("editdiv").show()}else{if(b=="edit>map"){$("mode").update("map>mix");$("editdiv").hide();$("quixeframe").hide();var a=Edit.PROJECT+".inform/Index/World.html";console.log(a);$("docuframe").src=a;$("docuframe").onload=function(){var f=$("docuframe").contentDocument;if(Edit.DEBUG_LIBS){var e="../../src/";var c="../../edit-i7-lib/";var d=document.createElement("script");d.setAttribute("src",e+"prototype-1.7.js");f.body.appendChild(d);var d=document.createElement("script");d.setAttribute("src",c+"patch-index.js");f.body.appendChild(d)}else{var e="../../edit-i7-lib/";var d=document.createElement("script");d.setAttribute("src",e+"js/hack_hooks.min.js");f.body.appendChild(d);var d=document.createElement("script");d.setAttribute("src",e+"js/glkote.min.js");f.body.appendChild(d);var d=document.createElement("script");d.setAttribute("src",e+"patch-index.js");f.body.appendChild(d)}console.log($("docuframe").contentDocument.location);$("docuframe").show()}}else{if(b=="map>mix"){$("mode").update("mix>play");$("docuframe").hide();$("editdiv").className="editdiv_mix";$("editdiv").show();$("quixeframe").className="quixeframe_mix";$("quixeframe").show()}else{alert("bug!")}}}}return false};Edit.requestSource=function(){document.title=document.title+" "+document.location;window.onhashchange=function(){console.log("edit.onhashchange");if(location.hash.substring(1)!==HackHooksFrame.last_hash){Edit.set_player()}};Edit.set_player();this.source_url=Edit.PROJECT_DIR+Edit.PROJECT+".inform/Source/story.ni";me=this;new Ajax.Request(this.source_url,{method:"get",onSuccess:function(b){var a=b.responseText;a=a.escapeHTML();a=a.replace(/\n/g,"<br>");a=a.replace(/  /g," &nbsp;");a=a.replace(/\t/g,"-- ");$("editdiv").update(a);$("editdiv").contentEditable="true";Hotkeys.bind("ctrl+s",function(){me.save_and_run()});Hotkeys.bind("tab",function(){document.execCommand("insertHTML",false,"--&nbsp;")});Hotkeys.bind("ctrl+1",function(){Edit.next_mode();return false})},onFailure:function(){alert("Something went wrong...")}})};Edit.set_player=function(){if(Edit.SKIP_GAME){return}var a=Edit.PLAYER+location.hash;console.log(a);$("quixeframe").src=Edit.PLAYER+location.hash};Edit.save_and_run=function(){try{this.save();if(!Edit.SKIP_GAME){this.run()}}catch(a){alert("Save-error "+a)}return false};Edit.save=function(){var h=/.*\//.exec(document.location)[0]+this.source_url;var f=getLocalPath(h);var j=$("editdiv").childNodes;var c="";for(var b=0;b<j.length;b++){var g=j[b];var d=g.textContent;if(g.nodeName==="BR"){d="\n"}c+=d}c=c.replace(/\u00A0/g," ");c=c.replace(/-- /g,"\t");var a=encode_utf8(c);if(!Edit.SKIP_GAME){mozillaSaveFile(f,a)}this.save_extension(c);return false};Edit.save_extension=function(m){l=m.split("\n");var d="";var e=null;for(var g=0;g<l.length;g++){var m=l[g];var a;if(a=/\"(.*)\" by \"(.*)\" \[begins here\]./.exec(m)){console.log(a);d+=(a[1]+" by "+a[2]+" begins here.");e=a}else{if(a=/\[(.* ends here.)\]/.exec(m)){console.log(m);d+=(a[1]+"\n\n---- DOCUMENTATION ----")}else{d+=(m)}}d+=("\n")}console.log(e);if(e){var b=e[1]+" by "+e[2]+".i7x";var f="Extensions/"+b;f=f.replace(/ /g,"_");var f=/.*\//.exec(document.location)[0]+f;console.log(f);f=getLocalPath(f);console.log("saving ext "+f);var k=encode_utf8(d);mozillaSaveFile(f,k);Edit.EXT_INSTALLER=Edit.DIR+"edit-i7-lib/edit_install_extension.py";var h=["-e",getLocalPath(Edit.EXT_INSTALLER),e[1],e[2],f];console.log(JSON.stringify(h));netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var f=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);f.initWithPath(Edit.XTERM);var c=Components.classes["@mozilla.org/process/util;1"].createInstance(Components.interfaces.nsIProcess);c.init(f);var j=this;c.runAsync(h,h.length)}};Edit.run=function(){var b=["-e",getLocalPath(Edit.BUILDER),"--wait",this.PROJECT_DIR+this.PROJECT,];console.log(JSON.stringify(b));netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var c=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);c.initWithPath(Edit.XTERM);var e=Components.classes["@mozilla.org/process/util;1"].createInstance(Components.interfaces.nsIProcess);e.init(c);var a="process-finished";function f(){this.register()}var d=this;f.prototype={observe:function(h,g,i){Edit.set_player()},register:function(){var g=Components.classes["@mozilla.org/observer-service;1"].getService(Components.interfaces.nsIObserverService);g.addObserver(this,a,false)},unregister:function(){var g=Components.classes["@mozilla.org/observer-service;1"].getService(Components.interfaces.nsIObserverService);g.removeObserver(this,a)}};$("quixeframe").src="";e.runAsync(b,b.length,new f());return false};function mozillaSaveFile(c,d){if(window.Components){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var b=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);b.initWithPath(c);if(!b.exists()){b.create(0,436)}var a=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);a.init(b,32|2,4,null);a.write(d,d.length);a.flush();a.close()}}function getLocalPath(e){var d=convertUriToUTF8(e);var b=d.indexOf("?");if(b!=-1){d=d.substr(0,b)}var a=d.indexOf("#");if(a!=-1){d=d.substr(0,a)}if(d.indexOf("file://localhost/")==0){d="file://"+d.substr(16)}var c;if(d.charAt(9)==":"){c=unescape(d.substr(8)).replace(new RegExp("/","g"),"\\")}else{if(d.indexOf("file://///")==0){c="\\\\"+unescape(d.substr(10)).replace(new RegExp("/","g"),"\\")}else{if(d.indexOf("file:///")==0){c=unescape(d.substr(7))}else{if(d.indexOf("file:/")==0){c=unescape(d.substr(5))}else{c="\\\\"+unescape(d.substr(7)).replace(new RegExp("/","g"),"\\")}}}}return c}function convertUriToUTF8(d,c){if(window.netscape==undefined||c==undefined||c==""){return d}try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var b=Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService)}catch(a){return d}return b.convertURISpecToUTF8(d,c)}function encode_utf8(a){return unescape(encodeURIComponent(a))}function decode_utf8(a){return decodeURIComponent(escape(a))};