if(!window.console){window.console={log:function(a){}}}HackHooks={AJAX:false,BROWSIE_BASE:"../Browsies/",PARTNER_FRAME_ORIGIN:"*",AJAX_DEBUG:false,FAKE_HISTORY:false,FAKE_INPUT:false,main_winid:-1,windowdic:null,image:null,send_response:null,quixe_options:null,log:[],next_log:[],hash:null,replaying:null,basetitle:null,base_md5:null,base_len:0,last_req_id:0,post_parent:function(a){if(parent!=window){parent.HackHooksFrame.receiveMessage(a,document.location)}},print:function(a){a="["+a+"]";console.log("print> "+a);var c=$("window"+this.main_winid).childElements();var b=c[c.length-1];b.insert({before:'<div class="BufferLine">'+a.escapeHTML()+"</div>"})},set_quixe_options:function(a){this.quixe_options=a},proxy_url:function(){return"/proxy/"},error_msg:function(a){console.log(a);this.print(a)},started:function(d){this.post_parent(["started",null]);var a=this.AJAX_DEBUG&&location.hash=="";if(a&&this.FAKE_HISTORY){var b;location.hash=" "+Base64.encode(JSON.stringify(this.FAKE_HISTORY))}console.log("started "+this.main_winid);this.basetitle=document.title;this.image=d;this.hash=location.hash;var c=this;window.onhashchange=function(){c.hash_change()};console.log("first indexing");this.load_hash();this.log=this.next_log;this.finish_started=function(e){if(this.AJAX){console.log("finish_started");if(e.req_id!=this.last_req_id){this.error_msg("ajax out of order, ignored "+e.req_id+"/"+this.last_req_id)}else{this.next_log=e.full_log;this.base_md5=e.base_log_md5;this.base_len=e.full_log.length}}console.log("replay");this.do_history();if(this.AJAX){if(parent!=window&&parent.HackHooksFrame){parent.HackHooksFrame.subframe_started(this)}}if(a&&this.FAKE_INPUT){console.log("fake input");var f=this.windowdic.get(this.main_winid);this.send_response("line",f,this.FAKE_INPUT,null)}};if(!this.AJAX){this.finish_started(null)}else{this.index_history("HackHooks.finish_started",{read:true})}},load_hash:function(){var a=location.hash.substring(1);this.next_log=[];a=Base64.decode(a);if(a!==""){try{a=JSON.parse(a);this.next_log=a.log;this.base_md5=a.base_md5}catch(b){}}},index_history:function(d,a){if(this.AJAX){var c="/index_history";this.last_req_id++;var b=this;new Ajax.Request(c,{method:"get",parameters:{json:JSON.stringify({jsonp:d,req_id:this.last_req_id,opt:a,history:{log:this.log.slice(this.base_len),base_md5:this.base_md5,},})},evalJS:"force",onFailure:function(e){b.error_msg("Server-problem, history not saved. Error "+e.status+": "+e.statusText)}})}},notify_new_win:function(a){if(this.main_winid==-1){this.main_winid=a}},got_line:function(a){console.log("got_line> "+a.value);if(this.replaying&&(/^save|^transcript/.exec(a.value))){a.value="#On replay ignored: "+a.value}this.log.push(a.value);if(!this.replaying){this.set_url_hash();this.update_title();this.index_history("HackHooks.finish_got_line",{write:true});this.finish_got_line=function(e){this.base_md5=e.base_log_md5;this.base_len=e.log_len;this.set_url_hash()}}var c=this;var d=$("window"+c.main_winid).childElements();var b=d[d.length-1];b.insert({before:"<hr>"})},do_history:function(){this.log=[];var b=this.windowdic.get(this.main_winid);this.replaying=true;for(var a=0;a<this.next_log.length;a++){this.send_response("line",b,this.next_log[a],null)}this.replaying=false;this.update_title()},hash_change:function(){var a=this.hash!==location.hash;if(a){if(true||confirm("url-skein has changed, reload?")){window.location.reload()}}return true},set_url_hash:function(){var a=JSON.stringify({log:this.log.clone().splice(this.base_len),base_md5:this.base_md5});var b=Base64.encode(a);location.hash=b;this.hash=location.hash;HackHooks.post_parent(["subframe_sets_hash",this.hash.substring(1)])},update_title:function(){var a=this.log.length>0?this.log[this.log.length-1]:"New Game";document.title=a+" - "+this.log.length+" - "+this.basetitle},clean_hyper:function(d){d=d.escapeHTML();var a=0;var b="";var c=/(.*?)(\w\+)?(\w*)\{(.*?)\}(.*?)/g;while(url=c.exec(d)){a=c.lastIndex;if(!url[4]){url[4]=url[3];url[3]=""}b+=url[1]+url[4]+url[5]}if(a){b+=d.substr(a)}return b},insert_special_text:function(c,d){console.log("insert_text>"+d);var a;if(a=/^(.*?.). Url: (.*)$/.exec(d)){if(!/^\/|.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(this.clean_hyper(a[1])+".");c.appendChild(e);return true}else{if(a=/^(.*?.). IFrame: (\w*), (.*)/.exec(d)){if(!/^\/|.*:.*/.exec(a[3])){a[3]=this.BROWSIE_BASE+a[3]}var e=new Element("a",{href:a[3],target:"_blank",title:"opens in new window/tab"}).update(this.clean_hyper(a[1])+".");c.appendChild(e);if(!this.replaying){var g=new Element("br",{});c.appendChild(g);var f=new Element("iframe",{src:a[3],style:"width: 100%; height: "+a[2]});c.appendChild(f)}return true}else{if(a=/^(.*?.). Popup: (.*)/.exec(d)){if(!/^\/|.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(this.clean_hyper(a[1])+".");c.appendChild(e);if(!this.replaying){var g=new Element("br",{});c.appendChild(g);if((!this.replaying)&&confirm(this.clean_hyper(a[1])+". \n\nOpen in new window/tab?\n\n"+a[2])){window.open(a[2])}}return true}else{if(a=/^(.*?.). Browse: (.*)/.exec(d)){if(!/^\/|.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(this.clean_hyper(a[1])+".");c.appendChild(e);var g=new Element("br",{});c.appendChild(g);if((!this.replaying)&&confirm(this.clean_hyper(a[1])+". \n\nRemember to use back-button to go back to game.")){location.href=a[2]}return true}else{if(a=/^(.*?.). Image: (.*)/.exec(d)){if(!/^\/|.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(this.clean_hyper(a[1])+".");c.appendChild(e);if(!this.replaying){var g=new Element("br",{});c.appendChild(g);var f=new Element("img",{src:a[2]});c.appendChild(f)}return true}else{var h=-1;var b=/(.*?)(\w\+)?(\w*)\{(.*?)\}(.*?)/g;while(a=b.exec(d)){h=b.lastIndex;if(!a[4]){a[4]=a[3];a[3]=""}var i=this;c.appendChild(new Element("span").update(a[1]+" "));var e=new Element("a",{href:"enter://"+a[3]+" "+a[4],title:a[3]+" "+a[4]}).update(a[4].escapeHTML());(function(j){e.observe("click",function(k){k.stop();var l=i.windowdic.get(i.main_winid);i.send_response("line",l,j[3]+" "+j[4],null)})})(a);c.appendChild(e);c.appendChild(new Element("span").update(a[5].escapeHTML()))}if(h!=-1){c.appendChild(new Element("span").update(d.substr(h).escapeHTML()))}else{c.appendChild(new Element("span").update(d.escapeHTML()))}return true}}}}}return false}};var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(c){var a="";var k,h,f,j,g,e,d;var b=0;c=Base64._utf8_encode(c);while(b<c.length){k=c.charCodeAt(b++);h=c.charCodeAt(b++);f=c.charCodeAt(b++);j=k>>2;g=((k&3)<<4)|(h>>4);e=((h&15)<<2)|(f>>6);d=f&63;if(isNaN(h)){e=d=64}else{if(isNaN(f)){d=64}}a=a+this._keyStr.charAt(j)+this._keyStr.charAt(g)+this._keyStr.charAt(e)+this._keyStr.charAt(d)}return a},decode:function(c){var a="";var k,h,f;var j,g,e,d;var b=0;c=c.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(b<c.length){j=this._keyStr.indexOf(c.charAt(b++));g=this._keyStr.indexOf(c.charAt(b++));e=this._keyStr.indexOf(c.charAt(b++));d=this._keyStr.indexOf(c.charAt(b++));k=(j<<2)|(g>>4);h=((g&15)<<4)|(e>>2);f=((e&3)<<6)|d;a=a+String.fromCharCode(k);if(e!=64){a=a+String.fromCharCode(h)}if(d!=64){a=a+String.fromCharCode(f)}}a=Base64._utf8_decode(a);return a},_utf8_encode:function(b){b=b.replace(/\r\n/g,"\n");var a="";for(var e=0;e<b.length;e++){var d=b.charCodeAt(e);if(d<128){a+=String.fromCharCode(d)}else{if((d>127)&&(d<2048)){a+=String.fromCharCode((d>>6)|192);a+=String.fromCharCode((d&63)|128)}else{a+=String.fromCharCode((d>>12)|224);a+=String.fromCharCode(((d>>6)&63)|128);a+=String.fromCharCode((d&63)|128)}}}return a},_utf8_decode:function(a){var b="";var d=0;var e=c1=c2=0;while(d<a.length){e=a.charCodeAt(d);if(e<128){b+=String.fromCharCode(e);d++}else{if((e>191)&&(e<224)){c2=a.charCodeAt(d+1);b+=String.fromCharCode(((e&31)<<6)|(c2&63));d+=2}else{c2=a.charCodeAt(d+1);c3=a.charCodeAt(d+2);b+=String.fromCharCode(((e&15)<<12)|((c2&63)<<6)|(c3&63));d+=3}}}return b}};