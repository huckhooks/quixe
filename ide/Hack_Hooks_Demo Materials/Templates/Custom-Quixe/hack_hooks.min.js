if(!window.console){window.console={log:function(a){}}}HackHooksFrame={subframe_started:function(a){this.subframe=a}};HackHooks={AJAX:false,BROWSIE_BASE:"../Browsies/",AJAX_DEBUG:false,FAKE_HISTORY:false,FAKE_INPUT:false,main_winid:-1,windowdic:null,image:null,send_response:null,quixe_options:null,log:[],next_log:[],hash:null,replaying:null,basetitle:null,base_md5:null,base_len:0,last_req_id:0,print:function(a){a="["+a+"]";console.log(a);var c=$("window"+this.main_winid).childElements();var b=c[c.length-1];b.insert({before:'<div class="BufferLine">'+a.escapeHTML()+"</div>"})},set_quixe_options:function(a){this.quixe_options=a},proxy_url:function(){return"/proxy/"},error_msg:function(a){console.log(a)},started:function(d){var a=this.AJAX_DEBUG&&location.hash=="";if(a&&this.FAKE_HISTORY){var b;b={log:[],base_md5:"c426205835e37dd9b4a4ff445ff662d2"};b={log:["#fake history"]};location.hash=" "+JSON.stringify(b)}console.log("started "+this.main_winid);this.basetitle=document.title;this.image=d;this.hash=location.hash;var c=this;window.onhashchange=function(){c.hash_change()};console.log("first indexing");this.load_hash();this.log=this.next_log;this.finish_started=function(e){if(this.AJAX){console.log("finish_started>"+JSON.stringify(e));if(e.req_id!=this.last_req_id){this.error_msg("ajax out of order, ignored "+e.req_id+"/"+this.last_req_id)}else{this.next_log=e.full_log;this.base_md5=e.base_log_md5;this.base_len=e.full_log.length}}console.log("replay");this.do_history();if(this.AJAX){if(parent!=window&&parent.HackHooksFrame){parent.HackHooksFrame.subframe_started(this)}}if(a&&this.FAKE_INPUT){console.log("fake input");var f=this.windowdic.get(this.main_winid);this.send_response("line",f,"#fake input",null)}};if(!this.AJAX){this.finish_started(null)}else{this.index_history("HackHooks.finish_started",{read:true})}},load_hash:function(){var a=location.hash.substring(1);console.log(a);if(a[0]==="%"){a=unescape(a)}this.next_log=[];console.log(">"+a+"<");if(a!==""){try{a=JSON.parse(a);this.next_log=a.log;this.base_md5=a.base_md5}catch(b){}}},index_history:function(c,a){if(this.AJAX){var b="/index_history";this.last_req_id++;new Ajax.Request(b,{method:"post",parameters:{json:JSON.stringify({jsonp:c,req_id:this.last_req_id,opt:a,history:{log:this.log.slice(this.base_len),base_md5:this.base_md5,},})},evalJS:"force",onFailure:function(d){this.error_msg("Noe ("+b+"): Error "+d.status+": "+d.statusText)}})}},notify_new_win:function(a){if(this.main_winid==-1){this.main_winid=a}},got_line:function(a){console.log(JSON.stringify(a));if(this.replaying&&(/^save|^transcript/.exec(a.value))){a.value="#On replay ignored: "+a.value}this.log.push(a.value);if(!this.replaying){this.set_url_hash();this.update_title();this.index_history("HackHooks.finish_got_line",{write:true});this.finish_got_line=function(e){console.log("finish_got_line> "+JSON.stringify(e));this.base_md5=e.base_log_md5;this.base_len=e.log_len;this.set_url_hash()}}var c=this;var d=$("window"+c.main_winid).childElements();var b=d[d.length-1];b.insert({before:"<hr>"});console.log("got_line> done")},do_history:function(){this.log=[];console.log(this.next_log);var b=this.windowdic.get(this.main_winid);this.replaying=true;for(var a=0;a<this.next_log.length;a++){this.send_response("line",b,this.next_log[a],null)}this.replaying=false;this.update_title()},hash_change:function(){var a=this.hash!==location.hash;console.log("hashchange "+a);if(a){console.log("old: "+this.hash);console.log("new: "+location.hash);if(true||confirm("url-skein has changed, reload?")){window.location.reload()}}return true},set_url_hash:function(){var a=JSON.stringify({log:this.log.clone().splice(this.base_len),base_md5:this.base_md5});console.log(a);var b="# "+a;location.hash=b;this.hash=location.hash},update_title:function(){var a=this.log.length>0?this.log[this.log.length-1]:"New Game";document.title=a+" - "+this.log.length+" - "+this.basetitle},insert_special_text:function(c,d){var a;if(a=/^(.*?.). Url: (.*)$/.exec(d)){if(!/.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(a[1]+".");c.appendChild(e);return true}else{if(a=/^(.*?.). IFrame: (\w*), (.*)/.exec(d)){if(!/.*:.*/.exec(a[3])){a[3]=this.BROWSIE_BASE+a[3]}var e=new Element("a",{href:a[3],target:"_blank",title:"opens in new window/tab"}).update(a[1]+".");c.appendChild(e);if(!this.replaying){var g=new Element("br",{});c.appendChild(g);var f=new Element("iframe",{src:a[3],style:"width: 100%; height: "+a[2]});c.appendChild(f)}return true}else{if(a=/^(.*?.). Popup: (.*)/.exec(d)){if(!/\/|.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(a[1]+".");c.appendChild(e);if(!this.replaying){var g=new Element("br",{});c.appendChild(g);if((!this.replaying)&&confirm(a[1]+". \n\nOpen in new window/tab?\n\n"+a[2])){window.open(a[2])}}return true}else{if(a=/^(.*?.). Browse: (.*)/.exec(d)){if(!/.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(a[1]+".");c.appendChild(e);var g=new Element("br",{});c.appendChild(g);if((!this.replaying)&&confirm(a[1]+". \n\nRemember to use back-button to go back to game.")){location.href=a[2]}return true}else{if(a=/^(.*?.). Image: (.*)/.exec(d)){if(!/.*:.*/.exec(a[2])){a[2]=this.BROWSIE_BASE+a[2]}var e=new Element("a",{href:a[2],target:"_blank",title:"opens in new window/tab"}).update(a[1]+".");c.appendChild(e);if(!this.replaying){var g=new Element("br",{});c.appendChild(g);var f=new Element("img",{src:a[2]});c.appendChild(f)}return true}else{var h=0;var b=/(.*?) (\w*)\{(.*?)\}(.*?)/g;while(a=b.exec(d)){h=b.lastIndex;var i=this;c.appendChild(new Element("span").update(a[1]+" "));var e=new Element("a",{href:"enter://"+a[2]+" "+a[3],title:a[2]+" "+a[3]}).update(a[3]);(function(j){e.observe("click",function(k){k.stop();var l=i.windowdic.get(i.main_winid);i.send_response("line",l,j[2]+" "+j[3],null)})})(a);c.appendChild(e);c.appendChild(new Element("span").update(a[4]))}if(h){c.appendChild(new Element("span").update(d.substr(h)))}return h}}}}}return false}};